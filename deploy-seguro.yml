name: esteira eegura de governança (CI/CD)

# 1. GATILHO: O processo só inicia quando alguém altera o código
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ETAPA 1: INTEGRAÇÃO CONTÍNUA (O Robô testa)
  testes-e-seguranca:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar Código
        uses: actions/checkout@v3
      
      - name: Rodar Testes Unitários
        run: npm test
        # se falhar aqui, a esteira simplesmente PARA. ninguém consegue fazer deploy de código quebrado.

      - name: Verificar Vulnerabilidades (Security Scan)
        run: npm audit
        # se tiver brecha de segurança, a esteira PARA.

  # ETAPA 2: deploy em homologação (Ambiente de Teste)
  deploy-homologacao:
    needs: testes-e-seguranca # Só roda se a etapa anterior passar
    runs-on: ubuntu-latest
    environment: 
      name: staging # ambiente de staging/hom
    steps:
      - name: Deploy automático para servidor de testes
        run: ./script-deploy.sh --target=homologacao

  # ETAPA 3: deploy em produção (O "Cofre")
  deploy-producao:
    needs: deploy-homologacao # só roda se hom estiver ok
    runs-on: ubuntu-latest
    
    # aqui ta governança:
    environment: 
      name: production 
      # configuração no GitHub exige "Required Reviewers" (Aprovação Manual)
    
    steps:
      - name: Autenticação Segura (Sem senha visível)
        env:
          SSH_KEY: ${{ secrets.SSH_KEY_PROD }} # a chave fica num cofre digital, o estagiário não vê
        run: |
          echo "Conectando ao servidor de Produção..."

          ./script-deploy.sh --target=producao
